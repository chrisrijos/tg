<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/paper-styles/color.html">
<link rel="import" href="/resources/polymer/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="/resources/components/tg-tooltip-behavior.html">
<link rel="import" href="/resources/file_operations/tg-attachment-uploader.html">

<dom-module id="tg-attachment-uploader-list">
	<template>
		<style>
			:host {
				width: 100%;
				height: 100%;
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}

			.over {
				background: var(--paper-blue-100);
			}

			#fileSelect {
				cursor: pointer;
			}

			#container {
				@apply(--layout-vertical);
				@apply(--layout-flex);
				border:1px dashed #ff5555;
				padding: 8px;
				position: relative;
				box-sizing: border-box;
				background: white;
				overflow: auto; /* this is to make host scorable when needed */
				-moz-user-select: none;
				-ms-user-select: none;
				-webkit-user-select: none;
				user-select: none;
			}
			
			#openDialogOrDrop {
				display:flex;
				flex-direction: column;
				padding: 8px;
				margin-top: 4px;
				cursor: pointer;
				border: 1px dashed var(--paper-grey-700);
			}
			
			.dropHere {
				flex:auto;
				text-align: center;
				font-weight: 700;
				color: var(--paper-grey-400);			
			}
		</style>

		<div id="container" on-dragenter='_dragenter' on-dragover='_dragover' on-dragleave='_dragleave' on-drop='_drop'>
			<template is='dom-repeat' id='uploaders' items='[[_filesToUpload]]' as='f' rendered-item-count="{{_renderedCount}}">
				<tg-attachment-uploader style='width: 100%'
					id$='[[_makeId(index)]]'
					list-index='[[index]]'
					file='[[f]]'
					url='[[url]]'
					upload-size-limit-kb='[[uploadSizeLimitKb]]'
					mime-types-accepted='[[mimeTypesAccepted]]'
					process-uploading-stopped='[[_perUploaderListenerOnUploadingStopped]]'></tg-attachment-uploader>
			</template>
		</div>
		<div id="openDialogOrDrop" on-tap="_openFileDialog" on-dragenter='_dragenter' on-dragover='_dragover' on-dragleave='_dragleave' on-drop='_drop'>
			<span id="dropAreaTitle" class="dropHere">Click to select files or Drop files for upload...</span>
		</div>
	</template>
</dom-module>

<script>
(function () {
	Polymer({
		is: 'tg-attachment-uploader-list',

		behaviors: [Polymer.TgBehaviors.TgTooltipBehavior],

		properties: {
			/* If enabled will output names, number, total size and mime types of the selected files. */
			debug: {
				type: Boolean,
				value: false
			},
		    
			/* URI that points to a file processing resource. */
			url: {
				type: String,
			},

			/* The limit of data to be uploaded for processing in Kibibytes. */
			uploadSizeLimitKb: {
				type: Number,
				value: 20480 // 20 Mebibyte
			},

			/* Acceptable mime types for the files to be uploaded. */
			mimeTypesAccepted: {
				type: String,
				value: '*/*',
				observer: '_mimeTypesAcceptedChanged'
			},
		    
			/* A callback, which gets invoked when uploading of all files stopped, either due to success, error or abortion. */
			processUploadingStopped: {
			    type: Function
			},

			/* A callback, which gets invoked when uploading of the firt file in a sequence starts. Passes one argument -- the uploader performing file uploading. */
			processUploadingStarted: {
			    type: Function
			},

			numberOfUploaded: {
			    type: Number,
			    value: 0
			},
			
			numberOfFailed: {
			    type: Number,
			    value: 0
			},

			numberOfAborted: {
			    type: Number,
			    value: 0
			},
			
			attachments: {
			    type: Array,
			    value: function () {
			        return [];
			    }
			},
			
			_uploadInput: {
				type: Object
			},
			
            /* An array of files that need to be uploaded.
             * Should NOT be manipulated directly -- only via methods pushValue.*/
            _filesToUpload: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            
    			_perUploaderListenerOnUploadingStopped: {
    			    type: Function,
    			    value: function() {
	    			    return function(uploader) {
			    		    console.log("UPLOADER STOPPED FOR index=", uploader.listIndex, 'id=', uploader.id);
			    		    
			    		    // count successes and failures
			    		    if (uploader.status === uploader.statuses.COMPLETED) {
			    		        this.push('attachments', uploader.attachment);
			    		        this.numberOfUploaded = this.numberOfUploaded + 1;
			    		    } else if (uploader.status === uploader.statuses.ABORTED) {
			    		        this.numberOfAborted = this.numberOfAborted + 1;
			    		    } else if (uploader.status === uploader.statuses.ERROR) {
			    		        this.numberOfFailed = this.numberOfFailed + 1;
			    		    }
			    		    
			    		    // if a PENDING uploader was aborted then there is already one in progress,
			    		    // and there is no need to instigate any new upload -- this will the responsibility of that other uploader
			    		    if (uploader.status !== uploader.statuses.ABORTED || uploader.prevStatus !== uploader.statuses.PENDING) { 
							// let's find the next PENDING uploader
							let index = uploader.listIndex + 1;
							let pendingUploader = null;
							while (!pendingUploader && index < this.$.uploaders.items.length) {
								const id = this._makeId(index);
								const elem = Polymer.dom(this.root).querySelector("#" + id);
								if (elem && elem.status === elem.statuses.PENDING) {
									pendingUploader = elem;
								}
								index = index + 1;
							}
	
							// if the next PENDING uploader was found then activate it
							if (pendingUploader) {
								pendingUploader.canUpload = true;
							} else {
							    // if there is nothin else to upload then report that all uploading has stopped 
								this.uploadInProgress = false;
								if (this.processUploadingStopped) {
									this.processUploadingStopped();
								}
							}
			    		    }
			    		    
	    			    }.bind(this);
    			    }
    			},
    			
    			/* A property that is bound to track the number of rendered attachment uploader components by dom-repeate component 'uploaders'.
    			 * Changes in the number of rendered uploaders is used to decide if there is a need to start the actual uploading. */
    			_renderedCount: {
    			    type: Number,
    			    observer: '_renderedCountChanged'
    			},
    			
    			/* Indicates whether there are any uploads that have not yet completed. 
    			 * It is also used as part of '_renderedCountChanged' when deciding if a new upload should be started. */
    			uploadInProgress: {
    			    type: Boolean,
    			    value: false
    			}

		},
		
		/* Gets invoked upon the change to the number of attachment uploaders that are rendered by dom-repeate component 'uploaders'.
		 * It is used to instigate uploading of the first file in the added batch if there are no other uploads in progress. */
		_renderedCountChanged: function (newCount, oldCount) {
		  	if (oldCount >= 0 && this.uploadInProgress === false) {
		  	  	this.uploadInProgress = true;
		        const startId = this._makeId(oldCount);
			    const elem = Polymer.dom(this.root).querySelector("#" + startId);
			    if (elem) {
			        elem.canUpload = true;
			        if (this.processUploadingStarted) {
			            this.processUploadingStarted(elem);
			        }
			    }
		  	}
		},
		
		created: function() {
			// let's create an invisible file input element to be used for opening a file dialog
			this._uploadInput = document.createElement('input');
			this._uploadInput.type = 'file';
			this._uploadInput.setAttribute('multiple', ''); // support multiple files
			this._uploadInput.onchange = function() {
			    this.submitUploading(this._uploadInput.files);
			}.bind(this);
		},
		
		/**
         * Makes a value for attribute id based on the provided index.
         * Such id values are used for <tg-attachment-uploader> HTML elements representing list of files for upload. 
         */
		_makeId: function(index) {
		    const id = "tg-attachment-uploader-" + index;
			return id;
		},
		
        /* Pushes the specified file into the tail of attay _filesToUpload, which triggers its uploading */
        _pushFileForUpload: function(file) {
            this.push('_filesToUpload', file);
        },
        
        /* A function to be bound to on-tap of some visual element, trigerring openning of a file dialog to choose file for uploading */
		_openFileDialog: function(e) {
			// let give a chance for tap animation to do its work
			this.async(function() {
				if (this._uploadInput) {
					this._uploadInput.click();
				} else {
					throw new Error('this._uploadInput is not defined!');
				}
			}.bind(this), 200);
		},

		/* Function responsible for submitting files into the queue for uploading. */
		submitUploading: function(fileList) {
			const self = this;
			Array.from(fileList).forEach( file => self._pushFileForUpload(file) );
		},

		_mimeTypesAcceptedChanged: function(newValue, oldValue) {
			this._uploadInput.setAttribute('accept', newValue);
		},

		_dragenter: function(e) {
			e.stopPropagation();
			e.preventDefault();

			this.$.openDialogOrDrop.classList.add('over');
		},

		_dragover: function(e) {
			e.stopPropagation();
			e.preventDefault();
			
			this.$.openDialogOrDrop.classList.add('over');
		},

		_dragleave: function(e) {
			e.stopPropagation();
			e.preventDefault();
			
			this.$.openDialogOrDrop.classList.remove('over');
		},

		_drop: function(e) {
			e.stopPropagation();
			e.preventDefault();
			this.$.openDialogOrDrop.classList.remove('over');

			this.submitUploading(e.dataTransfer.files);
		}

	});
})();
</script>
