<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/components/tg-tree-table.html">
<link rel='import' href='/resources/master/actions/tg-action.html'>
<link rel="import" href="/resources/master/tg-entity-master.html">
<link rel="import" href="/resources/master/tg-entity-master-behavior.html">

<link rel="import" href="/resources/polymer/iron-resizable-behavior/iron-resizable-behavior.html">


<dom-module id="tg-security-matrix">
    <template>
        <style>
            :host {
                height: 100%;
                width: 100%;
                @apply(--layout-vertical);
            }
            .lock-layer {
                opacity: 0.5;
                display: none;
                background-color: white;
            }
            .lock-layer[lock] {
                display: initial;
            }
        </style>
        <tg-entity-master id="masterDom" entity-type="[[entityType]]" entity-id="new" _post-validated-default="[[_postValidatedDefault]]" _post-validated-default-error="[[_postValidatedDefaultError]]" _process-response="[[_processResponse]]" _process-error="[[_processError]]" _process-retriever-response="[[_processRetrieverResponse]]" _process-retriever-error="[[_processRetrieverError]]" _process-saver-response="[[_processSaverResponse]]" _process-saver-error="[[_processSaverError]]" _saver-loading="{{_saverLoading}}">
            <div style="width:100%;height:100%" class="relative layout vertical">
                <div>
                    <!-- filtering editors goes here -->
                </div>
                <tg-tree-table class="flex" id="securityMatrix" entities="[[entities]]">
                    <template is="dom-repeat" items="[[columns]]">
                        <tg-property-column property="[[item.property]]" children-property="[[item.childrenProperty]]" parent-property="[[item.parentProperty]]" width="[[item.width]]" min-width="[[item.minWidth]]" grow-factor="[[item.growFactor]]" type="[[item.type]]" column-title="[[item.title]]" column-desc="[[item.desc]]"></tg-property-column>
                    </template>
                </tg-tree-table>
                <div class="layout horizontal center-justified" style="padding:20px;">
                    <tg-action enabled-states='[[_actions.REFRESH.enabledStates]]' short-desc='[[_actions.REFRESH.shortDesc]]' long-desc='[[_actions.REFRESH.longDesc]]' current-state='[[currentState]]' shortcut='ctrl+r meta+r' role='refresh' action='[[_actions.REFRESH.action]]' post-action='{{_postRetrievedDefault}}' post-action-error='{{_postRetrievedDefaultError}}' style="margin:10px;"></tg-action>
                    <tg-action enabled-states='[[_actions.SAVE.enabledStates]]' short-desc='[[_actions.SAVE.shortDesc]]' long-desc='[[_actions.SAVE.longDesc]]' current-state='[[currentState]]' shortcut='ctrl+s meta+s' action='[[_actions.SAVE.action]]' post-action='{{_postSavedDefault}}' post-action-error='{{_postSavedDefaultError}}' style="margin:10px;"></tg-action>
                    <!-- save and cancel buttons goes here -->
                </div>
                <div class="lock-layer fit" lock$="[[lock]]"></div>
            </div>
        </tg-entity-master>
    </template>
    <script>
        (function () {
            'use strict'
            Polymer({
                is: 'tg-security-matrix',

                behaviors: [Polymer.IronResizableBehavior, Polymer.TgBehaviors.TgEntityMasterBehavior],

                properties: {
                    entityType: String,

                    /**
                     * The entity that comes from insertion point and holds the information for schduling.
                     */
                    entity: {
                        type: Object,
                        observer: "_entityChanged"
                    },

                    hierarchyColumn: Object,

                    columns: Array,
                    /**
                     * Need for locking schduling component during insertion point activation or refreshing.
                     */
                    lock: {
                        type: Boolean,
                        value: false
                    }
                },

                ready: function () {
                    //Configuring the security matrix master
                    this.entityType = "ua.com.fielden.platform.entity.SecurityMatrixSaveAction"
                },

                attached: function () {
                    this.async(function () {
                        if (!this._currBindingEntity) {
                            this.retrieve();
                        }
                    });
                },

                _entityChanged: function (newBindingEntity, oldOne) {
                    const newEntity = newBindingEntity ? newBindingEntity['@@origin'] : null;
                    if (newEntity) {
                        const columnList = [];
                        columnList.push({
                            title: "Security Tokens",
                            desc: "Security Tokens Hierarchy",
                            property: "title",
                            childrenProperty: "children",
                            parentProperty: "parent",
                            width: 200,
                            growFacor: 1,
                            minWidth: 200,
                            type: "String"
                        });
                        newEntity.get("userRoles").forEach(role => {
                            columnList.push({
                                title: role.get("key"),
                                desc: role.get("desc"),
                                property: role.get("key").replace(/\s+/gi, "_"),
                                width: 50,
                                minWidth: 50,
                                type: "Boolean"
                            });
                        });
                        this.columns = columnList;
                        console.log(newEntity);
                    }
                },

                _masterDom: function () {
                    return this.$.masterDom;
                },

                /**
                 * The core-ajax component for entity retrieval.
                 */
                _ajaxRetriever: function () {
                    return this._masterDom()._ajaxRetriever();
                },

                /**
                 * The core-ajax component for entity saving.
                 */
                _ajaxSaver: function () {
                    return this._masterDom()._ajaxSaver();
                },

                /**
                 * The validator component.
                 */
                _validator: function () {
                    return this._masterDom()._validator();
                },

                /**
                 * The component for entity serialisation.
                 */
                _serialiser: function () {
                    return this._masterDom()._serialiser();
                },

                /**
                 * The reflector component.
                 */
                _reflector: function () {
                    return this._masterDom()._reflector();
                },

                /**
                 * The toast component.
                 */
                _toastGreeting: function () {
                    return this._masterDom()._toastGreeting();
                }

            });
        })();
    </script>
</dom-module>