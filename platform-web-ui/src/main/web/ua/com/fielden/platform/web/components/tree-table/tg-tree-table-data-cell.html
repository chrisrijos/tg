<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/app/tg-app-config.html">
<link rel="import" href="/app/tg-reflector.html">
<link rel="import" href="/resources/reflection/tg-date-utils.html">

<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">

<dom-module id="tg-tree-table-data-cell">
    <style>
        :host {
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }
        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        paper-checkbox {
            --paper-checkbox-label-spacing: 0px;
            --paper-checkbox-checked-color: var(--paper-light-blue-700);
            --paper-checkbox-checked-ink-color: var(--paper-light-blue-700);
            --paper-checkbox-unchecked-color: var(--paper-grey-900);
            --paper-checkbox-unchecked-ink-color: var(--paper-grey-900);
        }
    </style>
    <template>
        <tg-app-config id="appConfig"></tg-app-config>
        <tg-reflector id="reflector"></tg-reflector>
        <paper-checkbox hidden$="[[!_isBooleanProp(entity, column)]]" checked="[[_getBindedValue(entity.*, column.property, column.type)]]" on-change="_stateChanged"></paper-checkbox>
        <a class="truncate" hidden$="[[!_isHyperlinkProp(entity, column)]]" href$="[[_getBindedValue(entity.*, column.property, column.type)]]">[[_getBindedValue(entity.*, column.property, column.type)]]</a>
        <div class="truncate" hidden$="[[!_isNotBooleanOrHyperlinkProp(entity, column)]]">[[_getBindedValue(entity.*, column.property, column.type)]]</div>
    </template>
    <script>
        (function () {
            const generateShortCollection = function (entity, property, typeObject) {
                var collectionValue = entity.get(property);
                var containerPropertyValue = entity.get(property.substr(0, property.lastIndexOf('.')));
                var keys = typeObject.compositeKeyNames();
                return collectionValue.map(function (subEntity) {
                    var key = keys.find(function (key) {
                        if (subEntity.get(key) !== containerPropertyValue) {
                            return key;
                        }
                    });
                    return subEntity.get(key);
                });
            };
            Polymer({

                is: "tg-tree-table-data-cell",

                properties: {
                    column: Object,
                    entity: Object
                },

                _isBooleanProp: function (entity, column) {
                    return column.type === 'Boolean' && this._getValueFromEntity(entity, column.property) !== null;
                },

                /**
                 * Determines whether property is Hypelink or not.
                 */
                _isHyperlinkProp: function (entity, column) {
                    return column.type === 'Hyperlink' && this._getValueFromEntity(entity, column.property) !== null;
                },

                /**
                 * Determines whether property is not boolean property or is.
                 */
                _isNotBooleanOrHyperlinkProp: function (entity, column) {
                    return !(this._isBooleanProp(entity, column) || this._isHyperlinkProp(entity, column));
                },

                /**
                 * Returns the property value of the specified entity.
                 */
                _getValueFromEntity: function (entity, property) {
                    return entity && entity.get(property);
                },

                /**
                 * Returns the value for entity for the specified property name and type.
                 */
                _getBindedValue: function (change, property, type) {
                    return this._getValue(change.base, property, type);
                },
                /**
                 * Returns the property value of the specified entity and converts it to string.
                 */
                _getValue: function (entity, property, type) {
                    if (entity === null || property === null || type === null || this._getValueFromEntity(entity, property) === null) {
                        return "";
                    } else if (this.$.reflector.findTypeByName(type)) {
                        var propertyValue = this._getValueFromEntity(entity, property);
                        if (Array.isArray(propertyValue)) {
                            propertyValue = generateShortCollection(entity, property, this.$.reflector.findTypeByName(type));
                        }
                        return Array.isArray(propertyValue) ? this.$.reflector.convert(propertyValue).join(", ") : this.$.reflector.convert(propertyValue);
                    } else if (type.lastIndexOf('Date', 0) === 0) { // check whether type startsWith 'Date'. Type can be like 'Date', 'Date:UTC:' or 'Date:Europe/London:'
                        var splitedType = type.split(':');
                        return _millisDateRepresentation(entity.get(property), splitedType[1] || null, splitedType[2] || null);
                    } else if (typeof entity.get(property) === 'number') {
                        if (type === 'BigDecimal') {
                            const metaProp = this.$.reflector.getEntityTypeProp(entity, property);
                            return this.$.reflector.formatDecimal(entity.get(property), this.$.appConfig.locale, metaProp && metaProp.scale(), metaProp && metaProp.trailingZeros());
                        } else {
                            return this.$.reflector.formatNumber(entity.get(property), this.$.appConfig.locale);
                        }
                    } else if (type === 'Money') {
                        const metaProp = this.$.reflector.getEntityTypeProp(entity, property);
                        return this.$.reflector.formatMoney(entity.get(property), this.$.appConfig.locale, metaProp && metaProp.scale(), metaProp && metaProp.trailingZeros());
                    } else if (type === 'Colour') {
                        return '#' + entity.get(property)['hashlessUppercasedColourValue'];
                    } else if (type === 'Hyperlink') {
                        return entity.get(property)['value'];
                    } else {
                        return entity.get(property);
                    }
                },

                _stateChanged: function (e) {}
            });
        })();
    </script>
</dom-module>
