<link rel="import" href="/resources/polymer/paper-styles/paper-styles-classes.html">
<link rel="import" href="/resources/polymer/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<link rel="import" href="/resources/master/tg-entity-master.html">
<link rel="import" href="/resources/master/tg-entity-master-behavior.html">
<link rel="import" href="/resources/master/tg-entity-master-styles.html">
<link rel="import" href="/resources/actions/tg-shortcut-processing-behavior.html">

<script>
    (function () {

        Polymer.TgBehaviors = Polymer.TgBehaviors || {};
        Polymer.TgBehaviors.TgEntityMasterTemplateBehaviorImpl = {

            ready: function () {
                var self = this;
                self.isMasterTemplate = true;
                self._registrationListener = self._registrationListener.bind(self);
                self.classList.add("canLeave");
                
                // the value for property uuid needs to be assign only if this has not been done yet
                if (self.uuid === undefined) {
                    self.uuid = self.is + '/' + self._reflector().generateUUID();
                }
            },
            
            attached: function() {
                var self = this;
                if (self.prefDim) {
                    self._masterDom().setAttribute('with-dimensions', 'true');
                } else {
                    self._masterDom().removeAttribute('with-dimensions');
                }
            },
            
            /**
             * Adds 'with-dimensions' attribute to this tg-entity-master to make it suitable for resizing: action bar is placed on top of scrollable editor container.
             * Returns current dimensions with widthUnit = heightUnit = 'px'.
             */
            makeResizable: function () {
                const self = this;
                const prefDim = {
                    width: self._masterDom().$.masterContainer.offsetWidth,
                    height: self._masterDom().$.masterContainer.offsetHeight,
                    widthUnit: 'px',
                    heightUnit: 'px'
                };
                this._masterDom().setAttribute('with-dimensions', 'true');
                return prefDim;
            },
            
            addOwnKeyBindings: function () {
                var ownKeyBindings = this._ownKeyBindings;
                if (this.$.loader) {
                    if (this.$.loader.wasLoaded) {
                        if (typeof this.$.loader.loadedElement.addOwnKeyBindings === 'function') {
                            this.$.loader.loadedElement.addOwnKeyBindings();
                            return;
                        }
                    } else {
                        this.$.loader.addEventListener('after-load', this._registrationListener);
                        return;
                    }
                }
                for (var shortcuts in ownKeyBindings) {
                    this.addOwnKeyBinding(shortcuts, ownKeyBindings[shortcuts]);
                }
            },

            removeOwnKeyBindings: function () {
                if (this.$.loader) {
                    if (this.$.loader.wasLoaded) {
                        if (typeof this.$.loader.loadedElement.removeOwnKeyBindings === 'function') {
                            this.$.loader.loadedElement.removeOwnKeyBindings();
                            return;
                        }
                    } else {
                        return;
                    }
                }
                Polymer.IronA11yKeysBehavior.removeOwnKeyBindings.call(this);
            },

            _shouldOverridePrefDim: function () {
                var parent = this.parentElement;
                while (parent && (parent.tagName !== 'TG-CUSTOM-ACTION-DIALOG' && parent.tagName !== 'TG-MENU-ITEM-VIEW')) {
                    if (parent.isMasterTemplate && parent.prefDim) {
                        return false;
                    }
                    parent = parent.parentElement;
                }
                return true;
            },
            
            _registrationListener: function (e) {
                var target = e.target || e.srcElement;

                if (target === this.$.loader) {
                    if (e.detail && typeof e.detail.addOwnKeyBindings === 'function') {
                        e.detail.addOwnKeyBindings();
                    }

                    this.$.loader.removeEventListener('after-load', this._registrationListener);
                }
            },

            /**
             * Returns the key event target it might be a dialog or this element if the master is not in dialog.
             * Also it configures key bindings if the master is not a part of compound master.
             */
            _getKeyEventTarget: function () {
                var parent = this;
                var automaticAddKeyBindings = true;
                while (parent && (parent.tagName !== 'TG-CUSTOM-ACTION-DIALOG' && parent.tagName !== 'TG-MENU-ITEM-VIEW')) {
                    if (parent.tagName === 'TG-MASTER-MENU-ITEM-SECTION') {
                        automaticAddKeyBindings = false;
                    }
                    parent = parent.parentElement;
                }
                if (automaticAddKeyBindings) {
                    this.addOwnKeyBindings();
                }
                return parent || this;
            },

            _masterDom: function () {
                return this.$.masterDom;
            },

            /**
             * The core-ajax component for entity retrieval.
             */
            _ajaxRetriever: function () {
                return this._masterDom()._ajaxRetriever();
            },

            /**
             * The core-ajax component for entity saving.
             */
            _ajaxSaver: function () {
                return this._masterDom()._ajaxSaver();
            },

            /**
             * The validator component.
             */
            _validator: function () {
                return this._masterDom()._validator();
            },

            /**
             * The component for entity serialisation.
             */
            _serialiser: function () {
                return this._masterDom()._serialiser();
            },

            /**
             * The reflector component.
             */
            _reflector: function () {
                return this._masterDom()._reflector();
            },

            /**
             * The toast component.
             */
            _toastGreeting: function () {
                return this._masterDom()._toastGreeting();
            },
            
            _shortcutPressed: function (e) {
                this.processShortcut(e, ['tg-action', 'tg-ui-action']);
            }
        };

        Polymer.TgBehaviors.TgEntityMasterTemplateBehavior = [
            Polymer.IronA11yKeysBehavior,
            Polymer.TgBehaviors.TgShortcutProcessingBehavior,
            Polymer.TgBehaviors.TgEntityMasterBehavior,
            Polymer.TgBehaviors.TgEntityMasterTemplateBehaviorImpl
        ];

    })();
</script>