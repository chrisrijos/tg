<link rel="import" href="/resources/polymer/iron-media-query/iron-media-query.html">

<style is="custom-style">
    .summary-dialog paper-button {
        color: var(--paper-light-blue-500);
        --paper-button-flat-focus-color: var(--paper-light-blue-50);
    }
    .summary-dialog paper-button:hover {
        background: var(--paper-light-blue-50);
    }
</style>

<style>
    /*Card related styles*/
    .card-material {
        margin: 20px 30px;
        overflow: hidden;
    }
    .card-toolbar {
        background-color: white;
        margin: 0 30px;
    }
    .card-header {
        border-bottom: 1px solid #e5e5e5;
    }
    .card-header-background {
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
    }
    .card-header-background[selected] {
        background-color: #F5F5F5;
        opacity: none;
    }
    .card-header-background:not([selected]) {
        background-color: white;
        opacity: 0.7;
    }
    .card-body {
        border-bottom-left-radius: 2px;
        border-bottom-right-radius: 2px;
    }
    .data-entry {
        padding: 0.75rem 1.5rem;
        min-width: 150px;
    }
    .data-label {
        font-size: 0.9rem;
        font-weight: 400;
        background: transparent;
        color: #757575;
        cursor: default;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
    }
    .data-value {
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.8rem;
        height: 1.8rem;
        border-bottom: 1px solid black;
        cursor: pointer;
        color: #212121;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
    }
    .expand-button {
        position: absolute;
        bottom: 0;
        left: calc(50% - 14px);
        padding: 0;
    }
    .card-icon {
        --iron-icon-width: 1.3rem;
        --iron-icon-height: 1.3rem;
    }
</style>

<iron-media-query id="mobileQuery" query="[[_calcMobileQuery()]]" on-query-matches-changed="_mobileChanged"></iron-media-query>
<iron-media-query id="tabletQuery" query="[[_calcTabletQuery()]]" on-query-matches-changed="_tabletChanged"></iron-media-query>
<iron-media-query id="desktopQuery" query="[[_calcDesktopQuery()]]" on-query-matches-changed="_desktopChanged"></iron-media-query>

<!-- The dialog for summary when egi is in card layout -->
<paper-dialog id="summaryDialog" class="summary-dialog" modal entry-animation="fade-in-animation" exit-animation="fade-out-animation" on-iron-overlay-closed="_summaryDialogClosed">
    <template is="dom-if" if="[[totals]]">
        <tg-flex-layout when-desktop="{{summaryLayout.desktop}}" when-tablet="{{summaryLayout.tablet}}" when-mobile="{{summaryLayout.mobile}}">
            <template is="dom-repeat" items="[[_calcCardSummary(columns)]]">
                <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(item)]]">
                    <div class="data-label truncate">[[item.columnTitle]]</div>
                    <div class="data-value relative">
                        <iron-icon class="card-icon" hidden$="[[!_isBooleanProp(totals, item)]]" icon="[[_getBooleanIcon(totals, item.property)]]"></iron-icon>
                        <a class="truncate" hidden$="[[!_isHyperlinkProp(totals, item)]]" href$="[[_getValue(totals, item.property, item.type)]]">[[_getValue(totals, item.property, item.type)]]</a>
                        <div class="truncate relative" hidden$="[[!_isNotBooleanOrHyperlinkProp(totals, item)]]">[[_getValue(totals, item.property, item.type)]]</div>
                    </div>
                </div>
            </template>
        </tg-flex-layout>
    </template>
    <div class="buttons">
        <paper-button dialog-confirm autofocus>Close</paper-button>
    </div>
</paper-dialog>

<template is="dom-if" if="[[cardLayout]]" restamp>
    <div class="card-toolbar layout vertical">
        <div class="layout horizontal center">
            <content select=".entity-specific-action"></content>
        </div>
        <div class="layout horizontal center">
            <paper-checkbox style="margin: 0 8px;" class="blue" checked="[[selectedAll]]" on-change="_allSelectionChanged" tooltip-text$="[[_selectAllTooltip(selectedAll)]]"></paper-checkbox>
            <paper-icon-button icon="editor:functions" on-tap="_showSummary" disabled$="[[!_isSummaryEnabled(egiModel, cardLayout)]]"></paper-icon-button>
            <content select=".standart-action"></content>
        </div>
    </div>
    <template is="dom-repeat" items="[[egiModel]]" as="egiEntity" index-as="entityIndex">
        <paper-material elevation="1" class="card-material layout vertical">
            <div class="card-header layout horizontal center justified relative" style$="[[_calcCardHeaderStyle(primaryAction, secondaryActions)]]">
                <div selected$="[[egiEntity.selected]]" class="card-header-background fit"></div>
                <div class="layout horizontal center relative">
                    <paper-checkbox class="blue" style="margin-right:11px;" checked="[[egiEntity.selected]]" on-change="_selectionChanged" tooltip-text$="[[_selectTooltip(egiEntity.selected)]]"></paper-checkbox>
                    <template is="dom-if" if="[[primaryAction]]">
                        <tg-ui-action show-dialog="[[primaryAction.showDialog]]" current-entity="[[egiEntity.entity]]" short-desc="[[primaryAction.shortDesc]]" long-desc="[[primaryAction.longDesc]]" icon="[[primaryAction.icon]]" component-uri="[[primaryAction.componentUri]]" element-name="[[primaryAction.elementName]]" element-alias="[[primaryAction.elementAlias]]" action-kind="[[primaryAction.actionKind]]" number-of-action="[[primaryAction.numberOfAction]]" attrs="[[primaryAction.attrs]]" create-context-holder="[[primaryAction.createContextHolder]]" require-selection-criteria="[[primaryAction.requireSelectionCriteria]]" require-selected-entities="[[primaryAction.requireSelectedEntities]]" require-master-entity="[[primaryAction.requireMasterEntity]]" pre-action="[[primaryAction.preAction]]" post-action-success="[[primaryAction.postActionSuccess]]" post-action-error="[[primaryAction.postActionError]]" should-refresh-parent-centre-after-save="[[primaryAction.shouldRefreshParentCentreAfterSave]]" ui-role="[[primaryAction.uiRole]]" icon-style="[[primaryAction.iconStyle]]"></tg-ui-action>
                    </template>
                </div>
                <div class="layout horizontal center relative">
                    <template is="dom-if" if="[[_isSecondaryActionsPresent(secondaryActions)]]">
                        <template is="dom-repeat" items="[[secondaryActions]]">
                            <tg-ui-action show-dialog="[[item.showDialog]]" current-entity="[[egiEntity.entity]]" short-desc="[[item.shortDesc]]" long-desc="[[item.longDesc]]" icon="[[item.icon]]" component-uri="[[item.componentUri]]" element-name="[[item.elementName]]" element-alias="[[item.elementAlias]]" action-kind="[[item.actionKind]]" number-of-action="[[item.numberOfAction]]" attrs="[[item.attrs]]" create-context-holder="[[item.createContextHolder]]" require-selection-criteria="[[item.requireSelectionCriteria]]" require-selected-entities="[[item.requireSelectedEntities]]" require-master-entity="[[item.requireMasterEntity]]" pre-action="[[item.preAction]]" post-action-success="[[item.postActionSuccess]]" post-action-error="[[item.postActionError]]" should-refresh-parent-centre-after-save="[[item.shouldRefreshParentCentreAfterSave]]" ui-role="[[item.uiRole]]" icon-style="[[item.iconStyle]]"></tg-ui-action>
                        </template>
                    </template>
                </div>
            </div>
            <div class="card-body" style$="[[_calcCardStyle(collapsePanelVisible)]]">
                <tg-flex-layout when-desktop="[[shortLayout.desktop]]" when-tablet="[[shortLayout.tablet]]" when-mobile="[[shortLayout.mobile]]">
                    @gridCardDom
                </tg-flex-layout>
                <!--Collapse panel that contains other components those weren't included into main view of card-->
                <template is="dom-if" if="[[collapsePanelVisible]]">
                    <iron-collapse opened="[[egiEntity.opened]]">

                        <tg-flex-layout when-desktop="[[longLayout.desktop]]" when-tablet="[[longLayout.tablet]]" when-mobile="[[longLayout.mobile]]">
                            @gridCardDom
                        </tg-flex-layout>
                    </iron-collapse>
                </template>
                <paper-icon-button hidden$="[[!collapsePanelVisible]]" class="expand-button" icon="[[_calcCollapseIcon(egiEntity.opened)]]" on-tap="_toggleCollapsePanel"></paper-icon-button>
            </div>
        </paper-material>
    </template>
</template>
<script>
    var val = {
        /**
         * Collapses all opened entities (has sens in card layout.)
         */
        collapseAllCards: function () {
            var i;
            for (i = 0; i < this.egiModel.length; i++) {
                this.set("egiModel." + i + ".opened", false);
            }
            this.openedEntities = [];
        },

        /**
         * Shows the summary dialog if the EGI is in card layout and there were totals defined.
         */
        _showSummary: function (e, detail, source) {
            //Openening dialog
            if (this.cardLayout && this.totals) {
                var summaryDialog = Polymer.dom(document.body).appendChild(this.$.summaryDialog);
                Polymer.dom.flush();

                this.async(function () {
                    summaryDialog.open();
                }, 200);
            }
        },

        /**
         *  listener for summary dialog close dialog.
         */
        _summaryDialogClosed: function (e, detail) {
            Polymer.dom(document.body).removeChild(this.$.summaryDialog);
            Polymer.dom.flush();
        },
        ///////////////////Next three functions are responsible for calculating media queries expressions for mobile tablet and desktop screens/////////
        _calcMobileQuery: function () {
            return "max-width: " + (this.$.appConfig.minTabletWidth - 1) + "px";
        },
        _calcTabletQuery: function () {
            return "(min-width: " + this.$.appConfig.minTabletWidth + "px) and (max-width: " + (this.$.appConfig.minDesktopWidth - 1) + "px)";
        },
        _calcDesktopQuery: function () {
            return "min-width: " + this.$.appConfig.minDesktopWidth + "px";
        },
        /**
         * Determines whether totals button is enable or disabled (only in card layout mode).
         */
        _isSummaryEnabled: function (entities, cardLayout) {
            return !!this.totals;
        },

        /**
         * Calculates the property name to select in card layout.
         */
        _calcPropertyToSelect: function (column) {
            return column.property === '' ? 'this' : column.property
        },
        /**
         * Returns the icon name according to entityOpened parameter. If entityOpened is true then it returns icon that says that this card can be
         * collapsed otherwise it can be expanded.
         */
        _calcCollapseIcon: function (entityOpened) {
            return entityOpened ? 'expand-less' : 'expand-more';
        },

        /**
         * Calculates the style of the card.
         */
        _calcCardStyle: function (collapsePanelVisible) {
            return "position: relative; background-color: white; " + (collapsePanelVisible ? "padding-bottom: 24px;" : '');
        },

        /**
         * Toggles the card's collapse panel for the specified entity.
         */
        _toggleCollapsePanel: function (e) {
            var index = e.model.entityIndex,
                opened = this.egiModel[index].opened;
            this.set("egiModel." + index + ".opened", !opened);
            _processEntitySelection(this.openedEntities, this.entities[index], !opened);
        },

        /**
         * Calcualtes the summary for card layout.
         */
        _calcCardSummary: function (columns) {
            var cardSummary = [];

            columns.forEach(function (item) {
                if (item.summary) {
                    item.summary.forEach(function (summary) {
                        cardSummary.push(summary);
                    });
                }
            });

            return cardSummary;
        },
    }
</script>