<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/resources/polymer/paper-styles/color.html">
<link rel="import" href="/resources/polymer/paper-progress/paper-progress.html">

<link rel="import" href="/resources/serialisation/tg-serialiser.html">
<link rel="import" href="/resources/components/tg-tooltip-behavior.html">
<link rel="import" href="/resources/file_operations/tg-file-processing-behavior.html">

<dom-module id="tg-attachment-uploader">
	<template>
		<style>
			:host {
				display: inline-block;
				position: relative;
				box-sizing: border-box;
				text-align: center;
				font: inherit;
				outline: none;
				-moz-user-select: none;
				-ms-user-select: none;
				-webkit-user-select: none;
				user-select: none;
			}

			.over {
				background: var(--paper-green-100);
			}

			#fileSelect {
				cursor: pointer;
			}

			#container {
				display: flex;
				flex-direction: column;
				border:1px dashed #aaaaaa;
			}
			
			.labelHolder {
				display:flex;
				flex-wrap: nowrap;
				align-items: center;
				padding-left: 8px;
			}
			
			.status {
				order: 1;
				padding-right: 4px;
				text-align: left; 
				float: left;
				text-transform: uppercase;
				font-weight: 700;
				color: var(--paper-grey-400);
			}
			
			.status::after {
				content: ':';
			}
			
			.fileName {
				flex: auto;
				order: 2;
				text-align: left;
				overflow: hidden;
    				text-overflow: ellipsis;
    				white-space: nowrap;
    				padding-right: 4px;
			}
			
			paper-progress {
				width: auto;
			}

			paper-progress.UPLOADING {
				--paper-progress-active-color: var(--paper-blue-700);
				--paper-progress-secondary-color: var(--paper-blue-200);
			}

			paper-progress.PROCESSING {
				--paper-progress-active-color: var(--paper-blue-700);
				--paper-progress-secondary-color: var(--paper-blue-200);
			}

			paper-progress.ERROR {
				--paper-progress-active-color: var(--paper-red-700);
				--paper-progress-secondary-color: var(--paper-red-200);
			}
			
			paper-progress.ABORTED {
				--paper-progress-active-color: var(--paper-grey-700);
				--paper-progress-secondary-color: var(--paper-grey-200);
			}

			paper-progress.COMPLETED {
				--paper-progress-active-color: var(--paper-green-500);
				--paper-progress-secondary-color: var(--paper-green-200);
			}
			
			paper-progress.PENDING {
				--paper-progress-active-color: var(--paper-grey-500);
				--paper-progress-secondary-color: var(--paper-grey-200);
			}
			
			.errorMsg {
				font-size: 12px;
				font-weight: 400;			
				color: var(--paper-input-container-invalid-color, --error-color);
				text-align: left;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				padding: 4px 8px 4px 8px;
			}
			
		</style>

		<div id="container" style="width:100%" tooltip-text$="[[_fileNameTooltip(fileName, _errorMsg)]]">
			<div class="labelHolder">
				<span class="status">[[status]]</span>
				<span class="fileName">[[fileName]]</span>
				<div style="order: 3">
					<paper-icon-button id="abortButton" disabled$="[[_abortDisabled(status)]]" on-tap="abortUploadIfPossible" icon="icons:cancel" class="abort-button custom-icon-buttons" tabIndex="-1" tooltip-text="Abort file uploading."></paper-icon-button>
				</div>
			</div>
			<paper-progress id="progressBar"></paper-progress>
			<span class='errorMsg' hidden$='[[!_errorMsg]]'>[[_errorMsg]]</span>
		</div>
		
        <tg-serialiser id="serialiser"></tg-serialiser>
		

		<!-- need also support some debug information on a selected file -->
		<template is='dom-if' if='[[debug]]'>
			<ul style='text-align: left; overflow: scroll'>
				<li>names of selected files: <span style='color: #6a1b9a'>[[_debug_fileNames]]</span></li>
				<li>number of selected files: <span style='color: #6a1b9a'>[[_debug_fileNum]]</span></li>
				<li>total size: <span style='color: #6a1b9a'>[[_debug_fileSize]]</span></li>
				<li>mime type(s): <span style='color: #6a1b9a'>[[_debug_mimeTypes]]</span></li>
			</ul>
		</template>

	</template>
</dom-module>

<script>
(function () {
	Polymer({
		is: 'tg-attachment-uploader',

		behaviors: [Polymer.TgBehaviors.TgFileProcessingBehavior, Polymer.TgBehaviors.TgTooltipBehavior],

		observers: [
			'_canTryFileUploading(file, url, uploadSizeLimitKb, mimeTypesAccepted, processUploadingStopped, canUpload, listIndex)'
		],
	
		properties: {
		    
		    statuses: {
		        type: Object,
		        readOnly: true,
		        value: function() { return {
			            		READY: 'READY',
			            		PENDING: 'PENDING',
			            		UPLOADING: 'UPLOADING',
			            		PROCESSING: 'PROCESSING',
			            		COMPLETED: 'COMPLETED', // indicate completion of the file upload
			            		ERROR: 'ERROR',         // indicate completion of the file upload
			            		ABORTED: 'ABORTED'};}   // indicate completion of the file upload
		    },

			status: {
				type: String,
				value: function() {
					return 'PENDING';
				},
				observer: '_statusChange'
			},
			
			fileName: {
			    type: String,
			    value: 'no file was provided for upload'
			},
			
			error: {
			  type: Object  
			},

			_errorMsg: {
				type: String
			},
			
			file: {
			    type: Object
			},

			/* This property is used by <tg-attachment-uploader-list> to record the position of this instance in the list for each of access. */
			listIndex: {
				type: Number  
			},
			
			canUpload: {
				type: Boolean,
				value: false
			},
			
			/*
			 * A callback function that accepts one argument -- an instance of 'this'.
			 * It is invoked upon completion of the file upload, be that successful completion, error or abortion
			 */
			processUploadingStopped: {
				type: Function
			},
			
			processResponse: {
				type: Function
			},

			processError: {
				type: Function
			},

			processFileUploadedEvent: {
				type: Function
			}

		},
		
		_canTryFileUploading: function(file, url, uploadSizeLimitKb, mimeTypesAccepted, processUploadingStopped, canUpload, listIndex) {
		    console.log('File provided:', file, ' url=', url, ' uploadSizeLimitKb = ', uploadSizeLimitKb, ' mimeTypesAccepted = ', mimeTypesAccepted, 'canUpload = ', this.canUpload, 'listIndex = ', this.listIndex);
			if (file instanceof File && this.status === this.statuses.PENDING && (this.canUpload === true || this.listIndex === 0)) {
			    this.upload(file);
			}    
		},
		
		_statusChange: function (newStatus, oldStatus) {
            const progressBar = this.$.progressBar;

 			// let's remove any styles associated with previous statuses
 			progressBar.classList.remove('slow');
            for (let key in this.statuses) {
                progressBar.classList.remove(this.statuses[key]);
	        }
            
		    // if the status becomes PENDING then progress bar should become indeterminate with appropriate styling
			progressBar.indeterminate = newStatus === this.statuses.PENDING;
			if (newStatus === this.statuses.PENDING) {
			    progressBar.classList.add('slow');
			}
			
            // update styling
	        progressBar.classList.add(newStatus);
            progressBar.updateStyles();
            
            if (this.processUploadingStopped && 
                (newStatus === this.statuses.COMPLETED || newStatus === this.statuses.ERROR || newStatus === this.statuses.ABORTED)) {
                this.processUploadingStopped(this);
            }

		},
		
        _updateProgress: function (percentage) {
            // update progress bar if 0 <= % <= 100, which is only applicable to PROCESSING and UPLOADING statuses
            if (percentage >= 0 && percentage <= 100) {
            		const progressBar = this.$.progressBar;
                if (this.status === this.statuses.PROCESSING) {
                		progressBar.value = percentage;
                } else if (this.status === this.statuses.UPLOADING) {
                    progressBar.value = 0;
                    progressBar.secondaryProgress = percentage;
                } else if (this.status === this.statuses.COMPLETED) { // percentage should really be 100%
                    progressBar.value = percentage;
                    progressBar.secondaryProgress = percentage;
                }
            }
        },
        
        _abortDisabled: function (status) {
        		return status !== this.statuses.UPLOADING;    
        },
        
        abortUploadIfPossible: function() {
            // check if we still can abort before aborting...
            if (this.status === this.statuses.UPLOADING) {
        			this.abort();    
            }
        },

        _fileNameTooltip: function (fileName, errorMsg) {
            return fileName + '<br><span>' + errorMsg + '</span>';
        },

		ready: function() {
			this.fpResponseHandler = function(e) {
			    this.status = this.statuses.COMPLETED;
				this._updateProgress(100);

				if (this.processResponse) {
					this.processResponse(e);
				}
			}.bind(this);

			this.fpErrorHandler = function(e) {
			    const getResult = (response) => {
				    const result = this.$.serialiser.deserialise(response);
				    if (typeof result === 'string') {
				        try {
							return JSON.parse(result);
				        } catch (parsingError) {
				            console.error(parsingError);
				            return {message: result}; // return as is
				        }
				    } else {
						return result;
				    }
			    }
			    
			    const result = getResult(e.currentTarget.response);
			    this.error = result;
			    this._errorMsg = result.message;

			    this.status = this.statuses.ERROR;
				if (this.processError) {
					this.processError(result);
				}
			}.bind(this);

			this.fpAbortEventHandler = function(e) {
			    this.status = this.statuses.ABORTED;
			}.bind(this);

			this.fpFileUploadingProgressEventHandler = function(prc) {
			    this.status = this.statuses.UPLOADING;
				this._updateProgress(prc);
			}.bind(this);

			this.fpFileProcessingProgressEventHandler = function(prc) {
			    this.status = this.statuses.PROCESSING;
				this._updateProgress(prc);
			}

			this.fpFileUploadedEventHandler = function() {
			    this._updateProgress(100); // make sure UPLOADING progress is at 100%
			    this.status = this.statuses.PROCESSING;
			    this._updateProgress(3); // set some small value such as 3% just to provide some feedback to about processing starting
			    
				if (this.processFileUploadedEvent) {
					this.processFileUploadedEvent();
				}
			}.bind(this);
		},
		
		upload: function(file) {
		    if (file instanceof File) {
		        // _handleFiles requires FileList or an array of files for legacy reasons
		        try {
		            // set progress to 0 as a new file is being uploaded
		            this.$.progressBar.value = 0;
		            this.$.progressBar.secondaryProgress = 0;
		            this._errorMsg = '';
		            this.error = {message: 'no errors'};
		            this.fileName = file.name;
		        		this._handleFiles([file]);
		        } catch (error) {
		            console.error(error);
		            this._errorMsg = error;
		            this.error = {message: error};
		            this.status = this.statuses.ERROR;
					if (this.processError) {
					    this.processError({message: error});
					}
		        }
		    }
		}
	});
})();
</script>
