<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/paper-button/paper-button.html">
<link rel="import" href="/resources/polymer/paper-styles/color.html">
<link rel="import" href="/resources/polymer/paper-progress/paper-progress.html">

<link rel="import" href="/app/tg-reflector.html">
<link rel="import" href="/resources/components/tg-tooltip-behavior.html">
<link rel="import" href="/resources/file_operations/tg-file-processing-behavior.html">

<dom-module id="tg-attachment-uploader">
	<template>
		<style>
			:host {
				display: inline-block;
				position: relative;
				box-sizing: border-box;
				text-align: center;
				font: inherit;
				outline: none;
				-moz-user-select: none;
				-ms-user-select: none;
				-webkit-user-select: none;
				user-select: none;
				cursor: pointer;
				z-index: 0;
			}

			.over {
				background: var(--paper-green-100);
			}

			#fileSelect {
				cursor: pointer;
			}

			#container {
				border:1px dashed #aaaaaa;
			}
			
			.labelHolder {
				display:flex;
				padding: 8px;
			}
			
			.status {
				padding-right: 4px;
				text-align: left; 
				float: left;
				text-transform: uppercase;
				font-weight: 700;
				color: var(--paper-grey-400);
			}
			
			.status::after {
				content: ':';
			}
			
			.fileName {
				text-align: left;
				overflow: hidden;
    				text-overflow: ellipsis;
    				white-space: nowrap;
			}
			
			paper-progress {
				width: auto;
			}

			paper-progress.UPLOADING {
				--paper-progress-active-color: var(--paper-blue-700);
				--paper-progress-secondary-color: var(--paper-blue-200);
			}

			paper-progress.PROCESSING {
				--paper-progress-active-color: var(--paper-blue-700);
				--paper-progress-secondary-color: var(--paper-blue-200);
			}

			paper-progress.ERROR {
				--paper-progress-active-color: var(--paper-red-700);
				--paper-progress-secondary-color: var(--paper-red-200);
			}
			
			paper-progress.ABORTED {
				--paper-progress-active-color: var(--paper-grey-700);
				--paper-progress-secondary-color: var(--paper-grey-200);
			}

			paper-progress.COMPLETED {
				--paper-progress-active-color: var(--paper-green-500);
				--paper-progress-secondary-color: var(--paper-green-200);
			}
			
			paper-progress.PENDING {
				--paper-progress-active-color: var(--paper-amber-500);
				--paper-progress-secondary-color: var(--paper-amber-200);
			}
			
		</style>

		<div id="container" on-tap='openFileDialog' on-dragenter='_dragenter' on-dragover='_dragover' on-dragleave='_dragleave' on-drop='_drop' style="width:100%" disabled$="[[_fpInProgress]]">
			<div class="labelHolder"><span class="status" tooltip-text="Current status">[[status]]</span><span class="fileName" tooltip-text$="[[fileName]]">[[fileName]]</span></div>
			<paper-progress id="progressBar"></paper-progress>
		</div>

		<!-- content below is only needed during the development phase and will be removed once the component it completed -->
		<br>
		<br>
		<paper-button raised roll="button" id="fileSelect" on-tap='openFileDialog' on-dragenter='_dragenter' on-dragover='_dragover' on-dragleave='_dragleave' on-drop='_drop' style="width:100%" disabled$="[[_fpInProgress]]">
			<span>[[status]]</span>
		</paper-button>


		<!-- need also support some debug information on a selected file -->
		<template is='dom-if' if='[[debug]]'>
			<ul style='text-align: left; overflow: scroll'>
				<li>names of selected files: <span style='color: #6a1b9a'>[[_debug_fileNames]]</span></li>
				<li>number of selected files: <span style='color: #6a1b9a'>[[_debug_fileNum]]</span></li>
				<li>total size: <span style='color: #6a1b9a'>[[_debug_fileSize]]</span></li>
				<li>mime type(s): <span style='color: #6a1b9a'>[[_debug_mimeTypes]]</span></li>
			</ul>
		</template>

	</template>
</dom-module>

<script>
	Polymer({
		is: 'tg-attachment-uploader',

		behaviors: [Polymer.TgBehaviors.TgFileProcessingBehavior, Polymer.TgBehaviors.TgTooltipBehavior],

		properties: {
		    
		    statuses: {
		        type: Object,
		        readOnly: true,
		        value: function() { return {
			            		READY: 'READY',
			            		PENDING: 'PENDING',
			            		UPLOADING: 'UPLOADING',
			            		PROCESSING: 'PROCESSING',
			            		COMPLETED: 'COMPLETED',
			            		ERROR: 'ERROR',
			            		ABORTED: 'ABORTED'};}
		    },

			status: {
				type: String,
				value: 'PENDING',
				observer: '_statusChange'
			},
			
			fileName: {
			    type: String,
			    value: 'no file was provided for upload'
			},

			processResponse: {
				type: Function
			},

			processError: {
				type: Function
			},

			processFileUploadedEvent: {
				type: Function
			}

		},
		
		_statusChange: function (newStatus, oldStatus) {
		    // if the status becomes PENDING then progress bar should become indeterminate with appropriate styling
			this.$.progressBar.indeterminate = newStatus === this.statuses.PENDING;
			if (this.$.progressBar.indeterminate === true) {
			    this.$.progressBar.classList.add('slow');
			    this.$.progressBar.classList.add(this.statuses.PENDING);
			    this.$.progressBar.updateStyles();
			}
		},
		
        updateProgress: function (percentage, status) {
            const progressBar = this.$.progressBar;

 			// let's remove any styles associated with previous statuses
 			progressBar.classList.remove('slow');
            for (let key in this.statuses) {
                progressBar.classList.remove(this.statuses[key]);
	        }
            
            // update progress bar if 0 <= % <= 100, which is only applicable to PROCESSING and UPLOADING statuses
            if (percentage >= 0 && percentage <= 100) {
                if (status === this.statuses.PROCESSING) {
                		progressBar.value = percentage;
                } else if (status === this.statuses.UPLOADING) {
                    progressBar.value = 0;
                    progressBar.secondaryProgress = percentage;
                }
            }

            // update styling
	        progressBar.classList.add(status);
            progressBar.updateStyles();
        },


		ready: function() {
			this.fpResponseHandler = function(e) {
			    this.status = this.statuses.COMPLETED;
				this.updateProgress(100, this.status);

				if (this.processResponse) {
					this.processResponse(e);
				}
			}.bind(this);

			this.fpErrorHandler = function(e) {
			    this.status = this.statuses.ERROR;
				this.updateProgress(-1, this.status); // -1 not to update the progress bar

				if (this.processError) {
					this.processError(e);
				}
			}.bind(this);

			this.fpAbortEventHandler = function(e) {
			    this.status = this.statuses.ABORTED;
				this.updateProgress(-1, this.status); // -1 not to update the progress bar
			}.bind(this);

			this.fpFileUploadingProgressEventHandler = function(prc) {
			    this.status = this.statuses.UPLOADING;
				this.fileName = this._debug_fileNames;
				this.updateProgress(prc, this.status);
			}.bind(this);

			this.fpFileProcessingProgressEventHandler = function(prc) {
			    this.status = this.statuses.PROCESSING;
				this.updateProgress(prc, this.status);
			}

			this.fpFileUploadedEventHandler = function() {
			    this.status = this.statuses.PROCESSING;
				if (this.processFileUploadedEvent) {
					this.processFileUploadedEvent();
				}
			}.bind(this);

		},

		_dragenter: function(e) {
			e.stopPropagation();
			e.preventDefault();
			this.$.fileSelect.classList.add('over');
		},

		_dragover: function(e) {
			e.stopPropagation();
			e.preventDefault();
			this.$.fileSelect.classList.add('over');
		},

		_dragleave: function(e) {
			e.stopPropagation();
			e.preventDefault();
			this.$.fileSelect.classList.remove('over');
		},

		_drop: function(e) {
			e.stopPropagation();
			e.preventDefault();

			var dt = e.dataTransfer;
			var files = dt.files;

			this.$.fileSelect.classList.remove('over');

			// _handleFiles is mixed in from TgFileProcessingBehavior
			this._handleFiles(files);
		}

	});
</script>
