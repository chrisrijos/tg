<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/polymer/iron-icon/iron-icon.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">

<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/resources/polymer/paper-styles/default-theme.html">
<link rel="import" href="/resources/polymer/paper-styles/color.html">

<dom-module id="tg-hierarchy-tree-table-cell">
    <style>
        :host {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            @apply(--layout-flex);
        }
        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        iron-icon[collapsed] {
            transform: rotate(-90deg);
        }
        paper-checkbox {
            --paper-checkbox-checked-color: var(--paper-light-blue-700);
            --paper-checkbox-checked-ink-color: var(--paper-light-blue-700);
            --paper-checkbox-unchecked-color: var(--paper-grey-900);
            --paper-checkbox-unchecked-ink-color: var(--paper-grey-900);
        }
        paper-checkbox[checked-state=SEMICHECKED] {
            --paper-checkbox-checked-color: #acdbfe;
            --paper-checkbox-checked-ink-color: var(--paper-menu-color);
        }
        paper-checkbox[group-checkbox] {
            --paper-checkbox-checked-color: var(--paper-light-green-700);
            --paper-checkbox-checked-ink-color: var(--paper-light-green-700);
            --paper-checkbox-unchecked-color: var(--paper-grey-900);
            --paper-checkbox-unchecked-ink-color: var(--paper-grey-900);
        }
        paper-checkbox[group-checkbox][checked-state=SEMICHECKED] {
            --paper-checkbox-checked-color: #bee5bf;
            --paper-checkbox-checked-ink-color: var(--paper-menu-color);
        }
        iron-icon[invisible] {
            visibility: hidden;
        }
        [highlighted] {
            font-weight: bold;
        }
    </style>
    <template>
        <iron-icon icon="icons:arrow-drop-down" style="flex-grow:0;flex-shrink:0;" invisible$="[[_isLeaf(entity)]]" collapsed$="[[collapsed]]" on-tap="_toggle"></iron-icon>
        <paper-checkbox class="center" checked="[[entity.entity._tokenChecked]]" checked-state$="[[state]]" group-checkbox$="[[_isGroupCheckbox(entity.children)]]" on-change="_stateChanged"></paper-checkbox>
        <div class="flex truncate" highlighted$="[[highlighted]]" tooltip-text$="[[entity.entity.desc]]">[[_getCellValue(entity.entity, column.property)]]</div>
    </template>
    <script>
        (function () {
            Polymer({

                is: "tg-hierarchy-tree-table-cell",

                properties: {
                    column: Object,
                    entity: Object,
                    highlighted: Boolean,
                    collapsed: {
                        type: Boolean,
                        notify: true
                    }
                },

                observers: ["_calcHierarchyCellStyle(entity, column, column.width, column.growFactor)"],

                attached: function () {
                    this.state = this.entity.entity._getState("_tokenChecked");
                    this.entity.entity._tokenRoleAssociationHandler["_tokenChecked"] = (value, state) => {
                        this.notifyPath("entity.entity._tokenChecked", value);
                        this.state = state;
                        this.updateStyles();
                        this.fire("tg-tree-state-changed");
                    };
                },

                _isLeaf: function (entity) {
                    return !(entity.entity.children && entity.entity.children.length > 0);
                },

                _stateChanged: function (e) {
                    const target = e.target || e.srcElement;
                    this.column.check(this.entity.entity, "_tokenChecked", target.checked);
                },

                _toggle: function (e) {
                    this.collapsed = !this.collapsed;
                    this.fire("tg-tree-toggle-collapse-state");
                },

                _calcHierarchyCellStyle: function (entity, column, columnWidth, columnGrowFactor) {
                    let paddingLeft = 0;
                    let parentEntity = entity.entity[column.parentProperty];
                    while (parentEntity) {
                        paddingLeft += 26;
                        parentEntity = parentEntity[column.parentProperty];
                    }
                    this.style["padding-left"] = paddingLeft + "px";
                    this.style["width"] = columnWidth + "px";
                    this.style["min-width"] = columnWidth + "px";
                    if (columnGrowFactor === 0) {
                        this.style["flex-grow"] = 0;
                        this.style["flex-shrink"] = 0;
                    } else {
                        this.style["flex-grow"] = columnGrowFactor;
                    }
                    this.style["box-sizing"] = "border-box";
                },

                _isGroupCheckbox: function (children) {
                    return !!(children && children.length > 0);
                },

                _getCellValue: function (entity, property) {
                    return entity.get(property);
                }
            });
        })();
    </script>
</dom-module>
