<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/polymer/iron-icon/iron-icon.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">

<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/resources/polymer/paper-styles/default-theme.html">
<link rel="import" href="/resources/polymer/paper-styles/color.html">

<dom-module id="tg-hierarchy-tree-table-cell">
    <style>
        :host {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            @apply(--layout-flex);
            overflow: hidden;
        }
        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        iron-icon[collapsed] {
            transform: rotate(-90deg);
        }
        paper-checkbox {
            --paper-checkbox-checked-color: var(--paper-light-blue-700);
            --paper-checkbox-checked-ink-color: var(--paper-light-blue-700);
            --paper-checkbox-unchecked-color: var(--paper-grey-900);
            --paper-checkbox-unchecked-ink-color: var(--paper-grey-900);
        }
        paper-checkbox[checked-state=SEMICHECKED] {
            --paper-checkbox-checked-color: #acdbfe;
            --paper-checkbox-checked-ink-color: var(--paper-menu-color);
        }
        paper-checkbox[group-checkbox] {
            --paper-checkbox-checked-color: var(--paper-light-green-700);
            --paper-checkbox-checked-ink-color: var(--paper-light-green-700);
            --paper-checkbox-unchecked-color: var(--paper-grey-900);
            --paper-checkbox-unchecked-ink-color: var(--paper-grey-900);
        }
        paper-checkbox[group-checkbox][checked-state=SEMICHECKED] {
            --paper-checkbox-checked-color: #bee5bf;
            --paper-checkbox-checked-ink-color: var(--paper-menu-color);
        }
        iron-icon[invisible] {
            visibility: hidden;
        }
        [highlighted] {
            font-weight: bold;
        }
    </style>
    <template>
        <iron-icon icon="icons:arrow-drop-down" style="flex-grow:0;flex-shrink:0;" invisible$="[[_isLeaf(entity)]]" collapsed$="[[entity.collapsed]]" on-tap="_toggle"></iron-icon>
        <div class="layout horizontal center flex" style$="[[_calcHierarchyCellStyle(entity, column)]]">
            <paper-checkbox checked="[[entity.entity._tokenChecked]]" checked-state$="[[state]]" group-checkbox$="[[_isGroupCheckbox(entity.children)]]" on-change="_stateChanged"></paper-checkbox>
            <div class="flex truncate" highlighted$="[[highlight]]" tooltip-text$="[[entity.entity.desc]]">[[_getCellValue(entity.entity, column.property)]]</div>
        </div>
    </template>
    <script>
        (function () {
            Polymer({

                is: "tg-hierarchy-tree-table-cell",

                properties: {
                    column: Object,
                    entity: Object,
                    entityIndex: Number,
                    highlight: Boolean
                },
                
                attached: function () {
                    this.state = this.entity.entity._getState("_tokenChecked");
                    this.entity.entity._tokenRoleAssociationHandler["_tokenChecked"] = (value, state) => {
                        this.notifyPath("entity.entity._tokenChecked", value);
                        this.state = state;
                        this.updateStyles();
                        this.fire("tg-tree-state-changed");
                    };
                },

                _isLeaf: function (entity) {
                    return !(entity.entity.children && entity.entity.children.length > 0);
                },

                _stateChanged: function (e) {
                    const target = e.target || e.srcElement;
                    this.column.check(this.entity.entity, "_tokenChecked", target.checked);
                },

                _toggle: function (e) {
                    this.fire("tg-tree-toggle-collapse-state", {
                        entity: this.entity,
                        entityIndex: this.entityIndex,
                        state: !this.entity.collapsed
                    });
                    this.notifyPath("entity.collapsed", this.entity.collapsed);
                },

                _calcHierarchyCellStyle: function (entity, column) {
                    let paddingLeft = 0;
                    let parentEntity = entity.entity[column.parentProperty];
                    while (parentEntity) {
                        paddingLeft += 26;
                        parentEntity = parentEntity[column.parentProperty];
                    }
                    return "padding-left: " + paddingLeft + "px; overflow:hidden;";
                },
                
                _isGroupCheckbox: function(children) {
                    return !!(children && children.length > 0);
                },

                _getCellValue: function (entity, property) {
                    return entity.get(property);
                }
            });
        })();
    </script>
</dom-module>
