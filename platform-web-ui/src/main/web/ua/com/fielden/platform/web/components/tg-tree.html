<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/polymer/iron-icon/iron-icon.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/iron-list/iron-list.html">

<dom-module id="tg-tree">
    <template>
        <style>
            /* Container styles*/
            :host {
                @apply(--layout-vertical);

            }
            iron-icon[collapsed] {
                transform: rotate(-90deg);
            }
            iron-icon[invisible] {
                visibility: hidden;
            }
        </style>
        <iron-list id="treeList" items="[[_entities]]" as="entity">
            <template>
                <div class="layout horizontal center" style$="[[_calcItemStyle(entity)]]">
                    <iron-icon icon="icons:arrow-drop-down" style="flex-grow:0;flex-shrink:0;" invisible$="[[!entity.entity.hasChildren]]" collapsed$="[[!entity.opened]]" on-tap="_toggle"></iron-icon>
                    <span>[[entity.entity.title]]</span>
                </div>
            </template>
        </iron-list>
    </template>
    <script>
        (function () {
            'use strict'
            
            const calculateNumberOfOpenedItems = function (entity) {
                let length = 0;
                if (entity.entity.hasChildren && entity.opened) {
                    length += entity.children.length;
                    entity.children.forEach(child => length += calculateNumberOfOpenedItems(child));
                }
                return length;
            };
            
            const getParentsPath= function (entity) {
                const path = [];
                let parent = entity;
                while (parent) {
                    path.push(parent.entity);
                    parent = parent.parent;
                }
                return path.reverse();
            }
            
            const getChildrenToAdd = function (entity) {
                const childrenToAdd = [];
                if (entity.opened && entity.entity.hasChildren) {
                    if (!entity.children || entity.children.length === 0) {
                        childrenToAdd.push({
                            entity: {
                                title: "Loading data...",
                                hasChildren: false,
                            },
                            opened: false,
                            parent: entity,
                            loaderIndicator: true
                        });
                        this.fire("tg-load-subtree", getParentsPath(entity));
                    } else {
                        entity.children.forEach(child => {
                            childrenToAdd.push(child);
                            childrenToAdd.push(...getChildrenToAdd.bind(this)(child));
                        });
                    }
                }
                return childrenToAdd;
            };
            
            const generateChildrenModel = function (children, parentEntity) {
                return children.map(child => {
                    const parent = {
                        entity: child,
                        parent: parentEntity,
                        opened: false
                    };
                    if (child.hasChildren && child.children && && child.children.length > 0) {
                        parent.children = generateChildrenModel(child.children, parent);
                    }
                    return parent;
                });
            };
            
            Polymer({
                is: 'tg-tree',

                properties: {

                    /**
                     * Represents tree model
                     */
                    model: {
                        type: Array,
                        observer: "_modelChanged"
                    },

                    /**
                     * Represents the linear tree model.
                     */
                    _entities: {
                        type: Array
                    },
                },
                
                observers: ["_modelChanged(model.*)"],

                ready: function () {
                    //Add some event listeners and do other logic before attached callback.
                },

                attached: function () {},
                
                _regenerateModel: function () {
                    
                    this._entities = generateChildrenModel(this.model);
                },
                
                _modelChanged: function (change) {
                    if (change.path === "model") {
                        this._regenerateModel();
                    } else if (change.path === 'model.splices') {
                        console.log(change.value.indexSplices);
                    }
                },

                _toggle: function (e) {
                    console.log(e.model);
                    const entity = e.model.entity;
                    const idx = e.model.index;
                    if (entity.opened) {
                        this.splice("_entities", idx + 1, calculateNumberOfOpenedItems(entity));
                        this.set("_entities." + idx + ".opened", false);
                    } else {
                        this.set("_entities." + idx + ".opened", true);
                        this.splice("_entities", idx + 1, 0, ...getChildrenToAdd.bind(this)(entity));
                    }
                },
                
                _calcItemStyle: function (entity) {
                    let paddingLeft = 0;
                    let parent = entity.parent;
                    while (parent) {
                        paddingLeft += 16;
                        parent = parent.parent;
                    }
                    return "padding-left: " + paddingLeft + "px";
                }

            });
        })();
    </script>
</dom-module>