<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/polymer/iron-icon/iron-icon.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/iron-list/iron-list.html">

<dom-module id="tg-tree">
    <template>
        <style>
            /* Container styles*/
            :host {
                @apply(--layout-vertical);

            }
            iron-icon[collapsed] {
                transform: rotate(-90deg);
            }
            iron-icon[invisible] {
                visibility: hidden;
            }
        </style>
        <iron-list items="[[_entities]]" as="entity">
            <template>
                <div class="layout horizontal center" style$="[[_calcItemStyle(entity)]]">
                    <iron-icon icon="icons:arrow-drop-down" style="flex-grow:0;flex-shrink:0;" invisible$="[[!entity.hasChildren]]" collapsed$="[[!entity.opened]]" on-tap="_toggle"></iron-icon>
                    <span>[[entity.title]]</span>
                </div>
            </template>
        </iron-list>
    </template>
    <script>
        (function () {
            'use strict'
            
            const calculateNumberOfOpenedItems = function (entity) {
                let length = 0;
                if (entity.hasChildren && entity.opened) {
                    length += entity.children.length;
                    entity.children.forEach(child => length += calculateNumberOfOpenedItems(child));
                }
                return length;
            };
            
            const getChildrenToAdd = function (entity) {
                const childrenToAdd = [];
                if (entity.opened && entity.hasChildren) {
                    entity.children.forEach(child => {
                        childrenToAdd.push(child);
                        childrenToAdd.push(...getChildrenToAdd(child));
                    });
                }
                return childrenToAdd;
            };
            
            Polymer({
                is: 'tg-tree',

                properties: {

                    /**
                     * Represents tree model
                     */
                    model: {
                        type: Array,
                        observer: "_modelChanged"
                    },

                    /**
                     * Represents the linear tree model.
                     */
                    _entities: {
                        type: Array
                    },



                },

                ready: function () {
                    //Add some event listeners and do other logic before attached callback.
                },

                attached: function () {},
                
                _modelChanged: function (newModel, oldModel) {
                    const generateChildrenModel = function (children, parentEntity) {
                        return children.map(child => {
                            const parent = {
                                title: child.title,
                                parent: parentEntity,
                                hasChildren: child.hasChildren,
                                opened: false
                            };
                            if (parent.hasChildren) {
                                parent.children = generateChildrenModel(child.children, parent);
                            }
                            return parent;
                        });
                    };
                    this._entities = generateChildrenModel(newModel);
                },

                _toggle: function (e) {
                    console.log(e.model);
                    const entity = e.model.entity;
                    const idx = e.model.index;
                    if (entity.opened) {
                        this.splice("_entities", idx + 1, calculateNumberOfOpenedItems(entity));
                        this.set("_entities." + idx + ".opened", false);
                    } else {
                        this.set("_entities." + idx + ".opened", true);
                        this.splice("_entities", idx + 1, 0, ...getChildrenToAdd(entity));
                    }
                },
                
                _calcItemStyle: function (entity) {
                    let paddingLeft = 0;
                    let parent = entity.parent;
                    while (parent) {
                        paddingLeft += 16;
                        parent = parent.parent;
                    }
                    return "padding-left: " + paddingLeft + "px";
                }

            });
        })();
    </script>
</dom-module>